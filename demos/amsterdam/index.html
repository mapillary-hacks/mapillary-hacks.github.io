<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Amsterdam Data - Mapillary</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
  <link href='style.css' rel='stylesheet' />
  <script src='https://unpkg.com/mapillary-js@2.6.0/dist/mapillary.min.js'></script>
  <link href='https://unpkg.com/mapillary-js@2.6.0/dist/mapillary.min.css' rel='stylesheet' />
</head>

<body>

<div id='map'></div>
<nav id='menu'></nav>
<div id='mly'><script src='mly.js'></script></div>

<script src='toggle.js'></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY2JlZGRvdyIsImEiOiI5Q09YRG1RIn0.Izu6OPJ4CEEaSSpGuys3Xg';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [4.8992156982421875,
          52.37203595971475],
    zoom: 13
});
map.on('style.load', function () {
  map.addSource('benches', {
      'type': 'geojson',
      'data': 'ams_bench.geojson'
  });
  map.addLayer({
      'id': 'benches',
      'type': 'circle',
      'source': 'benches',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[0]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('bikes', {
      'type': 'geojson',
      'data': 'ams_bikes.geojson'
  });
  map.addLayer({
      'id': 'bikes',
      'type': 'circle',
      'source': 'bikes',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[1]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('billboards', {
      'type': 'geojson',
      'data': 'ams_billboards.geojson'
  });
  map.addLayer({
      'id': 'billboards',
      'type': 'circle',
      'source': 'billboards',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[2]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('bridges', {
      'type': 'geojson',
      'data': 'ams_bridges.geojson'
  });
  map.addLayer({
      'id': 'bridges',
      'type': 'circle',
      'source': 'bridges',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[3]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('crosswalks', {
      'type': 'geojson',
      'data': 'ams_crosswalks.geojson'
  });
  map.addLayer({
      'id': 'crosswalks',
      'type': 'circle',
      'source': 'crosswalks',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[4]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('curbs', {
      'type': 'geojson',
      'data': 'ams_curbs.geojson'
  });
  map.addLayer({
      'id': 'curbs',
      'type': 'circle',
      'source': 'curbs',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[5]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('hydrants', {
      'type': 'geojson',
      'data': 'ams_hydrants.geojson'
  });
  map.addLayer({
      'id': 'hydrants',
      'type': 'circle',
      'source': 'hydrants',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[6]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('trash bins', {
      'type': 'geojson',
      'data': 'ams_trash.geojson'
  });
  map.addLayer({
      'id': 'trash bins',
      'type': 'circle',
      'source': 'trash bins',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[7]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('tunnels', {
      'type': 'geojson',
      'data': 'ams_tunnels.geojson'
  });
  map.addLayer({
      'id': 'tunnels',
      'type': 'circle',
      'source': 'tunnels',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[8]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('vegetation', {
      'type': 'geojson',
      'data': 'ams_vegetation.geojson'
  });
  map.addLayer({
      'id': 'vegetation',
      'type': 'circle',
      'source': 'vegetation',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[9]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  map.addSource('water', {
      'type': 'geojson',
      'data': 'ams_water.geojson'
  });
  map.addLayer({
      'id': 'water',
      'type': 'circle',
      'source': 'water',
      'paint': {
          'circle-opacity': 0.6,
          'circle-radius': 5,
          'circle-color': colors[10]
      },
      'layout' : {
        'visibility' : 'none'
      }
  });
  var popup = new mapboxgl.Popup({offset:[0, -20]});
  map.on('click', function (e) {
      var features = map.queryRenderedFeatures(e.point);
      console.log(features);
      var feature = features[0];
      lng = feature.geometry.coordinates[0];
      lat = feature.geometry.coordinates[1];
      map.flyTo({
          center: [lng,lat],
      });
      imgkey = feature.properties["key"];
      mly.moveToKey(imgkey)
      console.log(imgkey);
      try {
        map.removeLayer('selection');
        map.removeSource('selection');
        popup.remove();
      } catch (error) {
        //do nothing
      }
      try {
        var selection = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [lng, lat]
                }
            }]
        };
        map.addSource('selection', {
        "type": "geojson",
        "data": selection
        });
        map.addLayer({
          "id": "selection",
          "type": "circle",
          "source": "selection",
          "paint": {
              "circle-color": 'white',
              "circle-opacity": .3,
              "circle-radius": 15
          }
        }, map.getLayer(features));
      } catch (error) {
        //do nothing
      }
      var detection = map.getLayer(e);
      popup = new mapboxgl.Popup({offset:[0, -20]});
      popup.setLngLat(feature.geometry.coordinates).setHTML("Looking at: <b>"+ feature.layer.id + "</b>").addTo(map);
  });

  map.on('mousemove', function (e) {
      var features = map.queryRenderedFeatures(e.point, { layers: ['benches', 'bikes', 'billboards', 'bridges', 'crosswalks', 'curbs', 'hydrants', 'trash bins', 'tunnels', 'vegetation','water'] });
      map.getCanvas().style.cursor = 'pointer';
  });
});
</script>
</body>
</html>
